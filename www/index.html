<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>Blue Chat Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .bubble { padding: 10px 14px; border-radius: 18px; max-width: 80%; font-size: 14px; margin-bottom: 4px; }
        .me { background: #2563eb; color: white; border-bottom-right-radius: 4px; margin-left: auto; }
        .other { background: #e2e8f0; color: #1e293b; border-bottom-left-radius: 4px; margin-right: auto; }
        .sys { text-align: center; font-size: 10px; color: #94a3b8; margin: 10px 0; font-weight: bold; }
    </style>
</head>
<body class="h-screen overflow-hidden flex flex-col">

    <!-- Header -->
    <div class="bg-[#075e54] text-white p-4 shadow-md flex justify-between items-center z-10">
        <div>
            <h1 class="font-bold text-lg">Blue Chat Pro</h1>
            <div class="flex items-center gap-2">
                <div id="statusDot" class="w-2 h-2 bg-red-500 rounded-full"></div>
                <p id="status" class="text-[10px] opacity-80">Déconnecté</p>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="makeVisible()" class="bg-[#128c7e] px-2 py-1 rounded text-[10px] font-bold border border-[#25d366]">VISIBLE</button>
            <button onclick="scan()" class="bg-white text-[#075e54] px-3 py-1 rounded font-bold text-xs uppercase">Scan</button>
        </div>
    </div>

    <!-- Container -->
    <div id="chatView" class="flex-1 overflow-y-auto p-4 flex flex-col bg-[#e5ddd5] pb-24">
        <div class="text-center mt-20 text-slate-500">
            <p class="text-sm font-bold">1. Cliquez sur VISIBLE sur l'autre téléphone</p>
            <p class="text-sm font-bold mt-2">2. Cliquez sur SCAN ici</p>
        </div>
    </div>

    <!-- Input -->
    <div id="inputBar" class="p-3 bg-white border-t flex gap-2 fixed bottom-0 w-full shadow-lg hidden">
        <input id="input" type="text" class="flex-1 bg-slate-100 rounded-full px-4 py-2 outline-none text-sm" placeholder="Message...">
        <button onclick="send()" class="bg-[#075e54] text-white p-3 rounded-full shadow-md font-bold">➤</button>
    </div>

    <script>
        function log(m, type='sys') {
            const d = document.createElement('div');
            d.className = type === 'sys' ? 'sys' : `bubble ${type}`;
            d.innerText = m;
            const chat = document.getElementById('chatView');
            chat.appendChild(d);
            chat.scrollTop = chat.scrollHeight;
        }

        function setOnline(online, name) {
            const dot = document.getElementById('statusDot');
            const txt = document.getElementById('status');
            const bar = document.getElementById('inputBar');
            if(online) {
                dot.className = "w-2 h-2 bg-green-500 rounded-full shadow-[0_0_8px_#25d366]";
                txt.innerText = "Connecté à " + name;
                bar.classList.remove('hidden');
                document.getElementById('chatView').innerHTML = '';
                log("Conversation sécurisée établie", "sys");
            } else {
                dot.className = "w-2 h-2 bg-red-500 rounded-full";
                txt.innerText = "Déconnecté";
                bar.classList.add('hidden');
            }
        }

        document.addEventListener('deviceready', () => {
            log("Système Prêt. En attente de connexion...", "sys");
            checkPermissions();
            
            // Écouteur permanent (Serveur)
            // Utilisation de listenInsecure pour éviter les erreurs de "pairing"
            bluetoothSerial.listenInsecure(function() {
                setOnline(true, "Appareil distant");
                bluetoothSerial.subscribe('\n', d => log(d, 'other'), e => {});
            }, function(err) {
                console.log("Erreur serveur : " + err);
            });

        }, false);

        function checkPermissions() {
            if(!window.cordova) return;
            const p = cordova.plugins.permissions;
            p.requestPermissions([p.BLUETOOTH_SCAN, p.BLUETOOTH_CONNECT, p.ACCESS_FINE_LOCATION, p.BLUETOOTH_ADVERTISE], 
                s => {}, e => alert("Permissions refusées."));
        }

        function makeVisible() {
            // Rend le téléphone détectable pendant 300 secondes
            bluetoothSerial.setDiscoverable(300);
            alert("Ce téléphone est maintenant visible pendant 5 minutes.");
        }

        function scan() {
            document.getElementById('chatView').innerHTML = '<div class="sys">Recherche des appareils...</div>';
            bluetoothSerial.list(list => {
                if(list.length === 0) {
                    document.getElementById('chatView').innerHTML = '<div class="sys">Aucun appareil associé trouvé.</div>';
                }
                list.forEach(d => {
                    const btn = document.createElement('div');
                    btn.className = "bg-white p-4 rounded-xl shadow-sm border mb-2 active:bg-slate-50 flex justify-between items-center";
                    btn.innerHTML = `<div><div class="font-bold text-sm">${d.name || 'Inconnu'}</div><div class="text-[10px] text-slate-400 font-mono">${d.id}</div></div><div class="text-blue-600 font-bold text-xs uppercase">Connecter</div>`;
                    btn.onclick = () => connect(d.id, d.name);
                    document.getElementById('chatView').appendChild(btn);
                });
            }, err => alert(err));
        }

        function connect(id, name) {
            log("Tentative de connexion à " + name + "...", "sys");
            // Mode Insecure pour contourner les erreurs "Unable to connect"
            bluetoothSerial.connectInsecure(id, () => {
                setOnline(true, name);
                bluetoothSerial.subscribe('\n', d => log(d, 'other'), e => {});
            }, err => {
                alert("Erreur: " + err + "\n\nAssurez-vous que l'autre téléphone a cliqué sur 'VISIBLE' ou est bien associé.");
            });
        }

        function send() {
            const input = document.getElementById('input');
            const txt = input.value;
            if(!txt) return;
            bluetoothSerial.write(txt + "\n", () => {
                log(txt, 'me');
                input.value = '';
            }, err => alert("Échec d'envoi"));
        }
    </script>
</body>
</html>